<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heartlink.chat.model.mapper.ChatMapper">

    <!-- 채팅 중인 사용자 목록 조회 -->
    <select id="getActiveChatList" resultType="com.heartlink.chat.model.dto.ChatDto">
        SELECT
            bu.BASIC_USER_NICKNAME AS nickname,
            bp.PHOTO_PATH AS photoPath,
            mcl.CONTENT AS lastMessage
        FROM
            MATCHING_STATE ms
        JOIN
            BASIC_USER bu ON ms.MATCHED_USER_NO = bu.BASIC_USER_NO
        JOIN
            BASIC_USER_PHOTO bp ON bu.BASIC_USER_NO = bp.BASIC_USER_NO
        LEFT JOIN
            (SELECT MATCHING_NO, CONTENT
             FROM MATCHING_CHATTING_LOG
             WHERE CHAT_INDATE = (SELECT MAX(CHAT_INDATE)
                                  FROM MATCHING_CHATTING_LOG
                                  WHERE MATCHING_NO = MATCHING_NO)) mcl
        ON
            ms.MATCHING_NO = mcl.MATCHING_NO
        WHERE
            ms.MATCHING_STATE = 'Y'
            AND ms.MATCHING_CHATTING_STATE = 'N'
    </select>

</mapper>
