<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2e606de56cb20485d9ccd4bf443da31d&libraries=services"></script>
<link rel="stylesheet" th:href="@{/css/matching/matching_area.css}">
    <nav th:replace="~{fragments/navigation :: navigation}"></nav>
    <section class="matching-main-sec">
        <div class="container matching-out-box">
            <div class="matching-my-tabs">
                <a class="matching-tab-ico not-choice" hre  f="#">MBTI 매칭</a>
                <a class="matching-tab-ico not-choice" href="#">이상형 매칭</a>
                <a class="matching-tab-ico" th:href="@{/matching-area/main}">위치 기반 매칭</a>
            </div>
            <div class="matching-main-box">
                <div id="matching-map" class="map"></div>
                <a class="map-find" id="find-location">이곳에서 찾기</a>
                <div class="matching-list-box">
                    <p>매칭 가능 리스트</p>
                    <ul id="matching-list">

                    </ul>
                </div>
            </div>
        </div>
    </section>
<script>
    kakao.maps.load(function() {
        var addr = `[[${addr}]]`;
        var userSex = `[[${userSex}]]`;
        var map;

        if (typeof kakao.maps === 'undefined') {
            console.error('Kakao Maps API is not loaded.');
            return;
        }

        var mapContainer = document.getElementById('matching-map');
        var mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };

        map = new kakao.maps.Map(mapContainer, mapOption);

        var geocoder = new kakao.maps.services.Geocoder();

        geocoder.addressSearch(addr, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                console.log('Latitude:', coords.getLat());
                console.log('Longitude:', coords.getLng());

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="width:150px;text-align:center;padding:6px 0;">내 위치</div>'
                });
                infowindow.open(map, marker);

                map.setCenter(coords);
            }
        });

        // 마커 이미지
        var imageSrc = '/image/location-pin.png';

        async function fetchUsersInBounds(map) {
            var bounds = map.getBounds();

            try {
                const response = await fetch('/matching-area/bounds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        southLng: bounds.getSouthWest().getLng(), // 서쪽 경도
                        northLng: bounds.getNorthEast().getLng(), // 동쪽 경도
                        southLat: bounds.getSouthWest().getLat(), // 남쪽 위도
                        northLat: bounds.getNorthEast().getLat(), // 북쪽 위도
                        requesterSex: userSex
                    })
                });

                const responseJson = await response.json();

                console.log(responseJson);

                var positions = [];

                var matchingList = document.getElementById('matching-list');
                matchingList.innerHTML = '';

                // 사용자 데이터 배열을 반복하여 positions 배열을 생성합니다
                for (var i = 0; i < responseJson.length; i++) {
                    positions.push({
                        title: responseJson[i].basicUserName,
                        latlng: new kakao.maps.LatLng(responseJson[i].latitude, responseJson[i].longitude)
                    });
                }

                // 마커를 지도에 추가합니다
                for (var i = 0; i < positions.length; i++) {
                    var imageSize = new kakao.maps.Size(45, 45);
                    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: positions[i].latlng,
                        title: positions[i].title,
                        image: markerImage
                    });

                    // 리스트 항목 생성
                    var listItem = document.createElement('li');
                    listItem.className = 'matching-list-item';
                    listItem.innerHTML = `
                        <div class="matching-request-box">
                            <img src="/image/user_profile/${responseJson[i].profileImageUrl || 'default_image.png'}" class="matching-photo">
                            <a class="matching-request">매칭 신청</a>
                        </div>
                        <table class="matching-info">
                            <tr>
                                <td><p class="matching-name">${responseJson[i].basicUserName}</p></td>
                                <td><p class="matching-age">${calculateAge(responseJson[i].basicUserBirthdate)}세</p></td>
                            </tr>
                            <tr>
                                <td><p class="matching-hobby">${responseJson[i].hobbyName}</p></td>
                                <td class="info-menu"><p>취미</p></td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="matching-type">${responseJson[i].personalLike}</p>
                                </td>
                                <td class="info-menu">
                                    <p>LIKE</p>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <p class="matching-type">${responseJson[i].personalHate}</p>
                                </td>
                                <td class="info-menu">
                                    <p>HATE</p>
                                </td>
                            </tr>
                            <tr>
                                <td><p class="matching-mbti">${responseJson[i].basicUserMbti}</p></td>
                                <td class="info-menu"><p>MBTI</p></td>
                            </tr>
                        </table>
                    `;

                    matchingList.appendChild(listItem);

                }

            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('find-location').addEventListener('click', function() {
            fetchUsersInBounds(map);
        });

        function calculateAge(birthdateString) {
            // 주어진 생일 문자열을 Date 객체로 변환
            const birthdate = new Date(birthdateString);

            // 현재 날짜
            const today = new Date();

            // 생일의 연도, 월, 일
            const birthYear = birthdate.getFullYear();
            const birthMonth = birthdate.getMonth();
            const birthDay = birthdate.getDate();

            // 현재 연도, 월, 일
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();

            // 기본 나이 계산
            let age = currentYear - birthYear;

            // 생일이 아직 오지 않은 경우 나이 -1
            if (currentMonth < birthMonth || (currentMonth === birthMonth && currentDay < birthDay)) {
                age--;
            }

            return age;
        }

    });

</script>
<footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>
