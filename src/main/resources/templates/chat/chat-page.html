<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>

<body>
<link rel="stylesheet" th:href="@{/css/chat/chat-page.css}">
<nav th:replace="fragments/navigation :: navigation"></nav>

<main class="chatting-page">
    <input type="hidden" id="basicUserNo" th:value="${basicUserNo}">
    <input type="hidden" id="matchingNo" th:value="${matchingNo}">

    <!-- 채팅 중인 사용자 목록 -->
    <div class="chat-list-container">
        <ul class="chat-list">
            <li th:each="chat : ${activeChats}"
                class="chat-list-item"
                th:data-matchingNo="${chat.matchingNo}"
                th:onclick="'window.location.href=\'/chat/chatting?matchingNo=' + ${chat.matchingNo} + '\''">
                <img th:src="${chat.photoPath}" class="profile" alt="other profile">
                <div class="chat-info">
                    <span class="nik-name" th:text="${chat.nickname}">닉네임</span>
                    <span class="last-message" th:text="${chat.lastMessage}"></span>
                </div>
                <span class="notification">
                    <i class="fa fa-envelope"></i>
                </span>
                <!-- 나가기 버튼 추가 -->
                <span class="exit-chat" th:onclick="'event.stopPropagation(); exitChat(' + ${chat.matchingNo} + ');'">
                🚪
                </span>
            </li>
        </ul>
    </div>

    <!-- 채팅 로그 -->
    <div class="chat-main">
        <ul class="chat-thread" id="messageContainer">
            <li th:each="message : ${chatLogs}"
                th:classappend="${message.basicUserNo} == ${basicUserNo} ? 'self-chat' : 'other-chat'">
                <div class="chat-list-item2" th:if="${message.basicUserNo} != ${basicUserNo}">
                    <img th:src="${message.photoPath}" class="profile" alt="other profile">
                    <span class="nik-name" th:text="${message.nickname}">상대방</span>
                    <div class="other" th:text="${message.content}">상대방 메시지</div>
                </div>
                <div class="chat-list-item2" th:if="${message.basicUserNo} == ${basicUserNo}">
                    <div class="self" th:text="${message.content}">내 메시지</div>
                    <span class="nik-name" th:text="${message.nickname}">내 닉네임</span>
                    <img th:src="${message.photoPath}" class="profile" alt="self profile">
                </div>
            </li>
        </ul>
        <form class="chat-window" id="chatForm">
            <input class="chat-window-message" id="messageInput" name="chat-window-message" type="text" autocomplete="off" autofocus />
            <button type="submit">Send</button>
        </form>
    </div>
</main>
<script th:inline="javascript">
    const profiles = /*[[${profiles}]]*/ [];

    // 채팅 나가기
function exitChat(matchingNo) {
    if (confirm("채팅방에서 나가시겠습니까?")) {
        fetch('/chat/exit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ matchingNo: matchingNo }),
        })
        .then(response => {
            if (response.ok) {
                alert("채팅방에서 나갔습니다.");

                // 웹소켓 연결 종료
                if (stompClient && stompClient.connected) {
                    stompClient.disconnect(() => {
                        console.log("WebSocket connection closed.");
                        window.location.href = '/chat/chatting';
                    });
                } else {
                    window.location.href = '/chat/chatting';
                }
            } else {
                alert("나가기에 실패했습니다. 다시 시도해주세요.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("오류가 발생했습니다. 다시 시도해주세요.");
        });
    }
}

</script>

<script th:src="@{https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js}"></script>
<script th:src="@{https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js}"></script>
<script th:src="@{/js/chat/chat-page.js}"></script>
<footer th:replace="fragments/footer :: footer"></footer>
</body>
</html>
